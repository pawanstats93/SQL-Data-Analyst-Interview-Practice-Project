Use SQL_barra
select * from customers
select * from employees
select * from orders
select * from ordersArchive
select * from products

--Q1. Find customers whose score is higher than the average customer score.

select firstname, score from customers
where score > (select avg(score) from customers
				where score is not null	)
---AVG() automatically ignores NULL, so this condition is optional:

--Q2. Get total sales amount by product category.

select t.Category, sum(t.Amount) TotalSalesAmount from
(select p.Category, o.Quantity, o.Sales, cast(o.Quantity as int)*cast(o.Sales as int) as Amount from orders as o inner join products as p
on o.productID = p.productID) as t
group by t.Category 

--Optimized Query
select p.Category, sum(cast (o.Quantity as int) *cast(o.Sales as int)) as TotalSalesAmount from orders 
as o inner join products as p
on o.productID = p.productID
group by p.Category

--Q3. Identify the top 2 highest-selling products based on total sales.
select 
	top 2 p.Product, sum(cast (o.Quantity as int) *cast(o.Sales as int)) as TotalSalesAmount from orders 
as o inner join products as p
on o.productID = p.productID
group by 
	p.Product
order by 
	TotalSalesAmount desc

--Another Approach
select t2.* from (
select t1.* , dense_rank() over (order by TotalSalesAmount desc) as rnk from 
(
select p.Product, sum(cast (o.Quantity as int) *cast(o.Sales as int)) as TotalSalesAmount from orders 
as o inner join products as p
on o.productID = p.productID
group by p.Product) as t1) as t2
where t2.rnk <= 2

--Q4. Show number of orders handled by each salesperson.

select o.SalesPersonID, count(o.OrderID) Total_Orders from orders as o 
	left join employees as e
	on o.salesPersonID = e.EmployeeID
group by o.SalesPersonID


--Q5. Find customers who placed orders in both orders and orderArchive.

select distinct(o.CustomerID) from orders as o inner join ordersArchive as oa
on o.orderID = oa.orderID

--Another approach
select 
	customerID from Customers as c
where 
	c.customerID in (select CustomerID from OrdersArchive) 
	and	  
	c.customerID in (select customerID from orders)

--Q6. Calculate monthly sales trend from the orders table.

SELECT 
    YEAR(OrderDate) AS OrderYear,
    DATENAME(MONTH, OrderDate) AS MonthName,
    MONTH(OrderDate) AS MonthNumber,
    SUM(CAST(Quantity AS INT) * CAST(Sales AS DECIMAL(10,2))) AS Amount
FROM orders
GROUP BY 
    YEAR(OrderDate),
    MONTH(OrderDate),
    DATENAME(MONTH, OrderDate)
ORDER BY 
    MonthNumber

--Q7. Find orders where shipping address is missing but billing address is available.
select 
	orderID 
from Orders
where 
	ShipAddress is null 
	and BillAddress is not null

--Q8. Get the most recent order for each customer.
select 
	t.customerId,t.orderDate, t.OrderID, t.rnk	
from (select *, 
	ROW_NUMBER() over (partition by customerId order by OrderDate desc) as rnk
from orders) as t
where t.rnk =1

--Q9. Compare total sales between current orders and archived orders.
select * from Orders
select * from OrdersArchive

select 
	'Current Orders' AS OrderType, 
	sum(Cast(quantity as int)*Cast(Sales as decimal)) as Current_Total_Sales 
from orders

union all

select 
	'Archived Orders' AS OrderType, 
	sum(Cast(quantity as int)*Cast(Sales as decimal)) as Archived_Total_Sales 
from OrdersArchive

--Another Approach

SELECT
    (SELECT SUM(CAST(Quantity AS INT) * CAST(Sales AS DECIMAL(10,2))) FROM Orders)
        AS Current_Total_Sales,
    (SELECT SUM(CAST(Quantity AS INT) * CAST(Sales AS DECIMAL(10,2))) FROM OrdersArchive)
        AS Archived_Total_Sales

--Q10. Find the average order value per customer and show only customers with more than 1 order.

select * from customers
select * from orders

select 
	c.CustomerID, avg(cast(o.Quantity as int)*cast(o.Sales as decimal)) as Avg_Order_Value,
	count(o.orderID) as Orders
from orders as o inner join customers as c
	on o.CustomerID = c.CustomerID
	group by c.CustomerID
having count(o.orderID)>1

--Q11. Identify products that were never sold in the current orders table.

select * from orders
select * from products

select 
	p.ProductID, p.Product 
from products as p
	left join orders as o
	on p.ProductID = o.ProductID
where o.ProductID is null

--Q12. Find the total sales generated by each salesperson, along with their department.
select * from employees
select * from orders

select
	o.SalesPersonID,
	e.FirstName,
	e.LastName,
	e.Department, 
	sum(cast(o.Quantity as int)*cast(o.Sales as decimal)) as Amount
from orders as o 
	inner join Employees as e
	on e.employeeID = o.SalesPersonID
Group by e.FirstName,
		e.LastName,
		o.SalesPersonID,
		e.Department

--Q14. Find customers whose total purchase value is above the overall average customer sales.
select * from customers
select * from orders

select 
	o.CustomerID, 
	c.FirstName,	
	sum(cast(o.Quantity as int)*cast(o.Sales as decimal)) Total_Purchase
from orders as o
	inner join customers as c
	on o.CustomerID = c.CustomerID
group by 
	c.FirstName,
	o.CustomerID
having 
	sum(cast(o.Quantity as int)*cast(o.Sales as decimal)) >
	(select avg(CustomerTotal) from
	(SELECT 
           sum(CAST(Quantity AS INT) * CAST(Sales AS DECIMAL(10,2))) AS CustomerTotal
           FROM orders
           GROUP BY CustomerID ) as t)

